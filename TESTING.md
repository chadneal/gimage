# Gimage Testing Guide

This document explains the testing structure and how to run tests.

## Quick Start

```bash
# Run everything (unit tests + E2E tests + coverage report)
make test

# View the coverage report
open coverage-report.html
```

## Test Commands

### Primary Commands

| Command | Description | Speed | Cost |
|---------|-------------|-------|------|
| `make test` | Run ALL tests (unit + E2E) and generate coverage report | ~30s | ~$0.12 |
| `make test-unit` | Run unit tests only (no E2E, no coverage report) | ~5s | FREE |
| `make test-e2e` | Run all E2E tests (CLI + Generate Image) | ~25s | ~$0.12 |

### Specific Test Commands

| Command | Description | Speed | Cost |
|---------|-------------|-------|------|
| `make test-cli-e2e` | Run CLI E2E tests (resize, scale, crop) | ~1s | FREE |
| `make test-generate-e2e` | Run Generate Image E2E tests (Gemini, Vertex, Bedrock) | ~25s | ~$0.12 |
| `make test-coverage` | Generate coverage report from existing coverage.out | ~1s | FREE |

## Test Structure

### Unit Tests
- **Location**: `internal/*/` alongside source files
- **Coverage**: Core packages (imaging, generate, mcp, pkg)
- **Run with**: `make test-unit`
- **Target**: >80% coverage for core packages

### E2E Tests

#### CLI E2E Tests (FREE)
- **Location**: `test/integration/cli_e2e_test.go`
- **What**: Tests the actual CLI binary (resize, scale, crop commands)
- **No API calls**: Uses local test images
- **Run with**: `make test-cli-e2e`
- **Speed**: ~1 second
- **Cost**: FREE

#### Generate Image E2E Tests (COSTS MONEY)
- **Location**: `test/integration/generate_e2e_test.go`
- **What**: Tests real image generation APIs
- **APIs tested**:
  - Gemini API (uses free tier quota - effectively FREE)
  - Vertex AI (~$0.04 per test run)
  - AWS Bedrock Nova Canvas (~$0.08 per test run)
- **Run with**: `make test-generate-e2e` (prompts for confirmation)
- **Speed**: ~25 seconds
- **Cost**: ~$0.12 per full run

## Coverage Reports

Running `make test` or `make test-unit` generates two coverage reports:

### 1. `coverage-report.html` (RECOMMENDED)
- **Clean, readable summary**
- **Organized by package type**:
  - Core Packages (unit tested) - imaging, generate, mcp
  - CLI & Config Packages (E2E tested) - cmd, cli, config
- **Explains why CLI packages show 0% unit coverage** (they're E2E tested)
- **Color-coded coverage levels**
- **Light/Dark mode support**
- **Open with**: `open coverage-report.html`

### 2. `coverage.html` (DETAILED)
- **Line-by-line coverage detail**
- Generated by Go's built-in `go tool cover`
- Use for investigating specific uncovered lines
- Less readable but more detailed

## Test Output

When you run `make test`, you'll see:

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                        ðŸ§ª GIMAGE COMPLETE TEST SUITE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Step 1/4: Running unit tests with coverage...
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[unit test results]

Step 2/4: Running CLI E2E tests (free)...
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[CLI E2E test results]

Step 3/4: Running Generate Image E2E tests (costs money)...
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[Generate E2E test results]

Step 4/4: Generating coverage reports...
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ Coverage report generated: coverage-report.html

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                              âœ… TEST SUITE COMPLETE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ðŸ“Š Coverage Summary:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Total Coverage:      20.0%
  Core Packages:       49.9%

ðŸ“„ Test Reports:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  â€¢ coverage-report.html  (readable summary - OPEN THIS FIRST)
  â€¢ coverage.html         (detailed line-by-line)

ðŸ”— View Report:
  open coverage-report.html

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

## Understanding Coverage Percentages

### Why is Total Coverage ~20%?
- **Includes CLI and config packages** which are tested via E2E tests
- These packages show 0% unit coverage (expected and correct)
- They are fully tested, just not via unit tests

### Why is Core Package Coverage ~50%?
- **Core packages** (imaging, generate, mcp) have comprehensive unit tests
- Target is >80% coverage for these packages
- Some code paths require real API calls and are only tested via E2E

### Why Do CLI Packages Show 0%?
- CLI commands and configuration are tested via **E2E tests**
- E2E tests run the actual binary (not unit tests)
- This is the correct way to test CLI applications
- See `test/integration/cli_e2e_test.go` for these tests

## CI/CD Integration

### For Pull Requests
```bash
# Run fast unit tests only
make test-unit
```

### Before Release
```bash
# Run complete test suite including E2E
make test
```

### Nightly Builds
```bash
# Run all E2E tests to verify API integrations
make test-e2e
```

## Troubleshooting

### "coverage.out not found" when running `make test-coverage`
- Run `make test` or `make test-unit` first to generate coverage.out

### E2E tests failing with "credentials not configured"
- Run `gimage auth gemini` to set up Gemini credentials
- Run `gimage auth vertex` to set up Vertex AI credentials
- Run `gimage auth bedrock` to set up AWS Bedrock credentials

### E2E tests are expensive
- Use `make test-cli-e2e` for free CLI testing
- Only run `make test-generate-e2e` when needed
- Gemini API uses free tier (effectively free for development)
- Vertex and Bedrock cost ~$0.04-0.08 per test run

## Adding New Tests

### Unit Tests
1. Create `*_test.go` file alongside source code
2. Use table-driven tests for multiple scenarios
3. Mock external dependencies (use test fixtures)
4. Aim for >80% coverage

### E2E Tests
1. Add to `test/integration/cli_e2e_test.go` for CLI tests
2. Add to `test/integration/generate_e2e_test.go` for API tests
3. Use build tag `// +build e2e` at top of file
4. Document costs in test comments

## Best Practices

1. **Run `make test-unit` frequently** during development (fast, free)
2. **Run `make test` before commits** (comprehensive)
3. **Run `make test-e2e` before releases** (full integration validation)
4. **Check coverage reports** after adding new code
5. **Use `coverage-report.html`** for readable overview
6. **Use `coverage.html`** for line-by-line investigation

## Example Workflow

```bash
# 1. Make code changes
vim internal/imaging/resize.go

# 2. Run unit tests (fast feedback)
make test-unit

# 3. If tests pass, run full suite
make test

# 4. View coverage report
open coverage-report.html

# 5. If coverage is good, commit
git add .
git commit -m "Add feature X"

# 6. Before pushing, run E2E tests
make test-e2e

# 7. If all green, push
git push
```

## Coverage Goals

| Package | Current | Target | Status |
|---------|---------|--------|--------|
| internal/imaging | 90%+ | 90% | âœ… GOOD |
| internal/generate | 30%+ | 80% | ðŸš§ NEEDS WORK |
| internal/mcp | 70%+ | 80% | ðŸš§ NEEDS WORK |
| pkg/models | 100% | 100% | âœ… GOOD |
| internal/cli | 0% | 0% | âœ… E2E TESTED |
| internal/config | 0% | 0% | âœ… E2E TESTED |

**Note**: CLI and config packages are intentionally 0% unit coverage because they're tested via E2E tests.
